{% extends "base.html" %}

{% block title %}Sá»­a Äiá»ƒm ThÃ nh pháº§n{% endblock %}

{% block content %}
<div style="padding: 20px; max-width: 800px; margin: 0 auto;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>âœï¸ Sá»­a Äiá»ƒm ThÃ nh pháº§n</h2>
    <a href="{{ url_for('grades.list_thanh_phan') }}"
      style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
      â† Quay láº¡i danh sÃ¡ch
    </a>
  </div>

  <!-- Form sá»­a Ä‘iá»ƒm -->
  <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    {% if data.record %}
    <form method="POST" id="editGradeForm">
      <!-- Hidden field chá»©a ID cá»§a record Ä‘á»ƒ controller biáº¿t edit record nÃ o -->
      <input type="hidden" name="record_id" value="{{ data.record.id }}">

      <!-- ThÃ´ng tin sinh viÃªn (read-only) -->
      <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0; color: #495057;">ğŸ“‹ ThÃ´ng tin báº£n ghi</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
          <div>
            <strong>Sinh viÃªn:</strong> {{ data.record.student.ho_ten if data.record.student else 'N/A' }}
          </div>
          <div>
            <strong>Lá»›p:</strong> {{ data.record.student.lop.ten_lop if data.record.student and data.record.student.lop
            else 'N/A' }}
          </div>
          <div>
            <strong>MÃ´n há»c:</strong> {{ data.record.hocphan.ten_hp if data.record.hocphan else 'N/A' }}
          </div>
          <div>
            <strong>GiÃ¡o viÃªn:</strong> {{ data.record.teacher.ho_ten if data.record.teacher else 'N/A' }}
          </div>
        </div>
      </div>

      <!-- Form fields -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">

        <!-- Äiá»ƒm chuyÃªn cáº§n -->
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">
            ğŸ“š Äiá»ƒm chuyÃªn cáº§n: <span style="color: red;">*</span>
          </label>
          <input type="number" name="diem_chuyen_can" step="0.1" min="0" max="10"
            value="{{ data.record.diem_chuyen_can or '' }}"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
            oninput="calculateAverage()">
          <small style="color: #6c757d;">Thang Ä‘iá»ƒm tá»« 0 Ä‘áº¿n 10</small>
        </div>

        <!-- Äiá»ƒm bÃ i táº­p -->
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">
            ğŸ“ Äiá»ƒm bÃ i táº­p: <span style="color: red;">*</span>
          </label>
          <input type="number" name="diem_bai_tap" step="0.1" min="0" max="10"
            value="{{ data.record.diem_bai_tap or '' }}"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
            oninput="calculateAverage()">
          <small style="color: #6c757d;">Thang Ä‘iá»ƒm tá»« 0 Ä‘áº¿n 10</small>
        </div>

        <!-- Äiá»ƒm giá»¯a ká»³ -->
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">
            ğŸ¯ Äiá»ƒm giá»¯a ká»³: <span style="color: red;">*</span>
          </label>
          <input type="number" name="diem_giua_ky" step="0.1" min="0" max="10"
            value="{{ data.record.diem_giua_ky or '' }}"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
            oninput="calculateAverage()">
          <small style="color: #6c757d;">Thang Ä‘iá»ƒm tá»« 0 Ä‘áº¿n 10</small>
        </div>

        <!-- Há»c ká»³ -->
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">
            ğŸ“… Há»c ká»³: <span style="color: red;">*</span>
          </label>
          <select name="hoc_ky" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
            required>
            <option value="1" {% if data.record.hoc_ky=='1' %}selected{% endif %}>Há»c ká»³ 1</option>
            <option value="2" {% if data.record.hoc_ky=='2' %}selected{% endif %}>Há»c ká»³ 2</option>
            <option value="3" {% if data.record.hoc_ky=='3' %}selected{% endif %}>Há»c ká»³ 3</option>
          </select>
        </div>

        <!-- NÄƒm há»c -->
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">
            ğŸ—“ï¸ NÄƒm há»c: <span style="color: red;">*</span>
          </label>
          <select name="nam_hoc" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
            required>
            <option value="2023-2024" {% if data.record.nam_hoc=='2023-2024' %}selected{% endif %}>2023-2024</option>
            <option value="2024-2025" {% if data.record.nam_hoc=='2024-2025' %}selected{% endif %}>2024-2025</option>
            <option value="2025-2026" {% if data.record.nam_hoc=='2025-2026' %}selected{% endif %}>2025-2026</option>
          </select>
        </div>

        <!-- GiÃ¡o viÃªn -->
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">
            ğŸ‘¨â€ğŸ« GiÃ¡o viÃªn: <span style="color: red;">*</span>
          </label>
          <select name="ma_gv" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" required>
            {% if data.teachers %}
            {% for teacher in data.teachers %}
            <option value="{{ teacher.ma_gv }}" {% if data.record.ma_gv==teacher.ma_gv %}selected{% endif %}>
              {{ teacher.ho_ten }} ({{ teacher.ma_gv }})
            </option>
            {% endfor %}
            {% else %}
            <option value="{{ data.record.ma_gv }}">{{ data.record.teacher.ho_ten if data.record.teacher else
              data.record.ma_gv }}</option>
            {% endif %}
          </select>
        </div>
      </div>

      <!-- Äiá»ƒm trung bÃ¬nh preview -->
      <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center;">
        <h4 style="margin: 0; color: #1976d2;">ğŸ“Š Äiá»ƒm trung bÃ¬nh thÃ nh pháº§n</h4>
        <div id="averageDisplay" style="font-size: 24px; font-weight: bold; color: #1976d2; margin-top: 10px;">
          {% set avg = ((data.record.diem_chuyen_can or 0) + (data.record.diem_bai_tap or 0) + (data.record.diem_giua_ky
          or 0)) / 3 %}
          {{ "%.1f"|format(avg) }}
        </div>
        <small style="color: #666;">Tá»± Ä‘á»™ng cáº­p nháº­t khi thay Ä‘á»•i Ä‘iá»ƒm</small>
      </div>

      <!-- Buttons -->
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
        <button type="submit"
          style="background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ğŸ’¾ Cáº­p nháº­t Ä‘iá»ƒm
        </button>
        <a href="{{ url_for('grades.list_thanh_phan') }}"
          style="background: #6c757d; color: white; padding: 12px 30px; border-radius: 5px; text-decoration: none; font-size: 16px;">
          âŒ Há»§y bá»
        </a>
      </div>
    </form>

    {% else %}
    <!-- No record found -->
    <div style="text-align: center; padding: 40px; color: #6c757d;">
      <h3>âš ï¸ KhÃ´ng tÃ¬m tháº¥y báº£n ghi</h3>
      <p>Báº£n ghi Ä‘iá»ƒm thÃ nh pháº§n khÃ´ng tá»“n táº¡i hoáº·c Ä‘Ã£ bá»‹ xÃ³a.</p>
      <a href="{{ url_for('grades.list_thanh_phan') }}"
        style="background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
        â† Quay láº¡i danh sÃ¡ch
      </a>
    </div>
    {% endif %}
  </div>
</div>

<script>
  function calculateAverage() {
    const cc = parseFloat(document.querySelector('input[name="diem_chuyen_can"]').value) || 0;
    const bt = parseFloat(document.querySelector('input[name="diem_bai_tap"]').value) || 0;
    const gk = parseFloat(document.querySelector('input[name="diem_giua_ky"]').value) || 0;

    const average = (cc + bt + gk) / 3;
    const display = document.getElementById('averageDisplay');

    display.textContent = average.toFixed(1);

    // Color coding
    if (average >= 8) {
      display.style.color = '#28a745';
    } else if (average >= 5) {
      display.style.color = '#ffc107';
    } else {
      display.style.color = '#dc3545';
    }
  }

  // Form validation
  document.getElementById('editGradeForm').addEventListener('submit', function (e) {
    const cc = document.querySelector('input[name="diem_chuyen_can"]').value;
    const bt = document.querySelector('input[name="diem_bai_tap"]').value;
    const gk = document.querySelector('input[name="diem_giua_ky"]').value;

    if (!cc && !bt && !gk) {
      e.preventDefault();
      alert('Vui lÃ²ng nháº­p Ã­t nháº¥t má»™t loáº¡i Ä‘iá»ƒm!');
      return false;
    }

    if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n cáº­p nháº­t Ä‘iá»ƒm thÃ nh pháº§n nÃ y?')) {
      return true;
    } else {
      e.preventDefault();
      return false;
    }
  });
</script>
{% endblock %}