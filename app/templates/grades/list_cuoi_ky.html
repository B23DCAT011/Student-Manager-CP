{% extends "base.html" %}

{% block title %}Danh sÃ¡ch Äiá»ƒm Cuá»‘i ká»³{% endblock %}

{% block content %}
<div style="padding: 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>ğŸ¯ Danh sÃ¡ch Äiá»ƒm Cuá»‘i ká»³</h2>
    <div>
      <a href="{{ url_for('grades.add_cuoi_ky') }}"
        style="background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; margin-right: 10px;">
        + ThÃªm Ä‘iá»ƒm cuá»‘i ká»³
      </a>
      <a href="{{ url_for('grades.dashboard') }}"
        style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
        â† Dashboard
      </a>
    </div>
  </div>

  <!-- Filters -->
  <div
    style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <h3>ğŸ” Bá»™ lá»c</h3>
    <form method="GET"
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 15px;">
      <div>
        <label>Há»c ká»³:</label>
        <select name="hoc_ky" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Táº¥t cáº£ --</option>
          <option value="1" {% if data.current_filters.hoc_ky=='1' %}selected{% endif %}>Há»c ká»³ 1</option>
          <option value="2" {% if data.current_filters.hoc_ky=='2' %}selected{% endif %}>Há»c ká»³ 2</option>
          <option value="3" {% if data.current_filters.hoc_ky=='3' %}selected{% endif %}>Há»c ká»³ 3</option>
        </select>
      </div>
      <div>
        <label>NÄƒm há»c:</label>
        <select name="nam_hoc" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Táº¥t cáº£ --</option>
          <option value="2023-2024" {% if data.current_filters.nam_hoc=='2023-2024' %}selected{% endif %}>2023-2024
          </option>
          <option value="2024-2025" {% if data.current_filters.nam_hoc=='2024-2025' %}selected{% endif %}>2024-2025
          </option>
          <option value="2025-2026" {% if data.current_filters.nam_hoc=='2025-2026' %}selected{% endif %}>2025-2026
          </option>
        </select>
      </div>
      <div>
        <label>Lá»›p:</label>
        <select name="lop" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Táº¥t cáº£ --</option>
          {% if data.lops %}
          {% for lop in data.lops %}
          <option value="{{ lop.ma_lop }}" {% if data.current_filters.lop==lop.ma_lop %}selected{% endif %}>
            {{ lop.ten_lop }} ({{ lop.ma_lop }})
          </option>
          {% endfor %}
          {% endif %}
        </select>
      </div>
      <div>
        <label>MÃ´n há»c:</label>
        <select name="mon_hoc" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Táº¥t cáº£ --</option>
          {% if data.hocphans %}
          {% for hocphan in data.hocphans %}
          <option value="{{ hocphan.ma_hp }}" {% if data.current_filters.mon_hoc==hocphan.ma_hp %}selected{% endif %}>
            {{ hocphan.ten_hp }} ({{ hocphan.ma_hp }})
          </option>
          {% endfor %}
          {% endif %}
        </select>
      </div>
      <div style="display: flex; align-items: end;">
        <button type="submit"
          style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
          Lá»c káº¿t quáº£
        </button>
      </div>
    </form>
  </div>

  <!-- Stats Summary -->
  <div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
      <h4 style="margin: 0; color: #1976d2;">Tá»•ng mÃ´n</h4>
      <p style="font-size: 24px; font-weight: bold; color: #1976d2; margin: 5px 0;">{{ data.total_subjects }}</p>
    </div>
    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
      <h4 style="margin: 0; color: #2e7d32;">ÄÃ£ qua (â‰¥5.0)</h4>
      <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 5px 0;">{{ data.passed_count }}</p>
    </div>
    <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
      <h4 style="margin: 0; color: #c62828;">TrÆ°á»£t (<5.0)< /h4>
          <p style="font-size: 24px; font-weight: bold; color: #c62828; margin: 5px 0;">{{ data.failed_count }}</p>
    </div>
    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
      <h4 style="margin: 0; color: #f57c00;">GPA TB</h4>
      <p style="font-size: 24px; font-weight: bold; color: #f57c00; margin: 5px 0;">{{ "%.2f"|format(data.average_gpa or
        0) }}</p>
    </div>
  </div>

  <!-- Data Table -->
  <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3>ğŸ“‹ Báº£ng Ä‘iá»ƒm cuá»‘i ká»³ vÃ  tá»•ng káº¿t</h3>
      <div>
        <button onclick="exportTranscript()"
          style="background: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
          ğŸ“„ Xuáº¥t báº£ng Ä‘iá»ƒm
        </button>
        <button onclick="exportStatistics()"
          style="background: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">
          ğŸ“Š Xuáº¥t thá»‘ng kÃª
        </button>
      </div>
    </div>

    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8f9fa;">
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">MÃ£ SV</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Há» tÃªn</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Lá»›p</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">MÃ´n há»c</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Äiá»ƒm HP</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Káº¿t quáº£</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Thao tÃ¡c</th>
          </tr>
        </thead>
        <tbody>
          {% if data.cuoi_ky_records %}
          {% for grade in data.cuoi_ky_records %}
          <tr>
            <td style="padding: 12px; border: 1px solid #dee2e6;">{{ grade.ma_sv }}</td>
            <td style="padding: 12px; border: 1px solid #dee2e6;">
              <strong>{{ grade.student.ho_ten if grade.student else 'N/A' }}</strong>
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              {{ grade.student.lop.ten_lop if grade.student and grade.student.lop else 'N/A' }}
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              {{ grade.hocphan.ten_hp if grade.hocphan else 'N/A' }}
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              <span style="font-weight: bold; font-size: 16px;">{{ grade.diem_hp }}</span>
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              {% if grade.diem_hp and grade.diem_hp >= 5.0 %}
              <span
                style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Äáº¡t</span>
              {% else %}
              <span
                style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">TrÆ°á»£t</span>
              {% endif %}
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              <a href="/grades/cuoi-ky/edit/{{ grade.ma_sv }}/{{ grade.ma_hp }}"
                style="background: #007bff; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; margin: 2px;">
                âœï¸ Sá»­a
              </a>
              <button onclick="deleteGrade('{{ grade.ma_sv }}', '{{ grade.ma_hp }}')"
                style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin: 2px;">
                ğŸ—‘ï¸ XÃ³a
              </button>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="10" style="padding: 40px; text-align: center; color: #6c757d;">
              ğŸ¯ ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm cuá»‘i ká»³. <a href="{{ url_for('grades.add_cuoi_ky') }}">ThÃªm Ä‘iá»ƒm má»›i</a>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function deleteGrade(ma_sv, ma_hp) {
    if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a Ä‘iá»ƒm cuá»‘i ká»³ nÃ y?\nSinh viÃªn: ' + ma_sv + '\nMÃ´n há»c: ' + ma_hp)) {
      // Send AJAX request to delete
      fetch(`/grades/cuoi-ky/delete/${ma_sv}/${ma_hp}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('âœ… ' + data.message);
            location.reload(); // Refresh page to see changes
          } else {
            alert('âŒ Lá»—i: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('âŒ CÃ³ lá»—i xáº£y ra khi xÃ³a Ä‘iá»ƒm!');
        });
    }
  }

  function exportTranscript() {
    alert('Äang xuáº¥t báº£ng Ä‘iá»ƒm PDF...');
    // TODO: Implement transcript export
  }

  function exportStatistics() {
    alert('Äang xuáº¥t thá»‘ng kÃª Excel...');
    // TODO: Implement statistics export
  }
</script>
{% endblock %}