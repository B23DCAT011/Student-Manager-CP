{% extends "base.html" %}

{% block title %}Sá»­a Äiá»ƒm Cuá»‘i ká»³{% endblock %}

{% block content %}
<div style="padding: 20px; max-width: 800px; margin: 0 auto;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>âœï¸ Sá»­a Äiá»ƒm Cuá»‘i ká»³</h2>
    <a href="{{ url_for('grades.list_cuoi_ky') }}"
      style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
      â† Quay láº¡i danh sÃ¡ch
    </a>
  </div>

  <!-- Form sá»­a Ä‘iá»ƒm cuá»‘i ká»³ -->
  <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <form method="POST" id="editFinalGradeForm">
      {% if data.record %}
      <!-- ThÃ´ng tin sinh viÃªn vÃ  mÃ´n há»c (khÃ´ng thá»ƒ sá»­a) -->
      <div
        style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #007bff;">
        <h4 style="margin: 0 0 10px 0; color: #007bff;">ğŸ“‹ ThÃ´ng tin cÆ¡ báº£n</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div>
            <strong>ğŸ‘¨â€ğŸ“ Sinh viÃªn:</strong><br>
            {{ data.record.student.ho_ten }} ({{ data.record.ma_sv }})
          </div>
          <div>
            <strong>ğŸ“š MÃ´n há»c:</strong><br>
            {{ data.record.hocphan.ten_hp }} ({{ data.record.ma_hp }})
          </div>
          <div>
            <strong>ğŸ‘¨â€ğŸ« GiÃ¡o viÃªn:</strong><br>
            {{ data.record.teacher.ho_ten if data.record.teacher else 'ChÆ°a phÃ¢n cÃ´ng' }}
          </div>
        </div>
      </div>

      <!-- Hidden fields Ä‘á»ƒ giá»¯ khÃ³a chÃ­nh -->
      <input type="hidden" name="ma_sv" value="{{ data.record.ma_sv }}">
      <input type="hidden" name="ma_hp" value="{{ data.record.ma_hp }}">

      <!-- Form fields cÃ³ thá»ƒ sá»­a -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">

        <!-- Äiá»ƒm há»c pháº§n -->
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">
            ğŸ¯ Äiá»ƒm há»c pháº§n: <span style="color: red;">*</span>
          </label>
          <input type="number" name="diem_hp" step="0.1" min="0" max="10"
            value="{{ data.record.diem_hp if data.record.diem_hp else '' }}"
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
            oninput="updateGradePreview()" required>
          <small style="color: #6c757d;">Thang Ä‘iá»ƒm tá»« 0 Ä‘áº¿n 10</small>
        </div>
      </div>

      <!-- Äiá»ƒm preview -->
      <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center;">
        <h4 style="margin: 0; color: #1976d2;">ğŸ“Š Xáº¿p loáº¡i Ä‘iá»ƒm</h4>
        <div id="gradePreview" style="font-size: 24px; font-weight: bold; color: #1976d2; margin-top: 10px;">
          --
        </div>
        <small style="color: #666;">Tá»± Ä‘á»™ng cáº­p nháº­t khi nháº­p Ä‘iá»ƒm</small>
      </div>

      <!-- Buttons -->
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
        <button type="submit"
          style="background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ğŸ’¾ Cáº­p nháº­t Ä‘iá»ƒm
        </button>
        <a href="{{ url_for('grades.list_cuoi_ky') }}"
          style="background: #6c757d; color: white; padding: 12px 30px; border-radius: 5px; text-decoration: none; font-size: 16px;">
          âŒ Há»§y bá»
        </a>
      </div>

      {% else %}
      <div style="text-align: center; padding: 40px; color: #dc3545;">
        <h3>âŒ KhÃ´ng tÃ¬m tháº¥y Ä‘iá»ƒm cuá»‘i ká»³</h3>
        <p>Äiá»ƒm cuá»‘i ká»³ cáº§n sá»­a khÃ´ng tá»“n táº¡i hoáº·c Ä‘Ã£ bá»‹ xÃ³a.</p>
        <a href="{{ url_for('grades.list_cuoi_ky') }}"
          style="background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
          Quay láº¡i danh sÃ¡ch
        </a>
      </div>
      {% endif %}
    </form>
  </div>
</div>

<script>
  function updateGradePreview() {
    const diem = parseFloat(document.querySelector('input[name="diem_hp"]').value) || 0;
    const preview = document.getElementById('gradePreview');

    let grade = '';
    let color = '';

    if (diem >= 8.5) {
      grade = 'A - Xuáº¥t sáº¯c';
      color = '#28a745';
    } else if (diem >= 7.0) {
      grade = 'B - Giá»i';
      color = '#28a745';
    } else if (diem >= 5.5) {
      grade = 'C - KhÃ¡';
      color = '#ffc107';
    } else if (diem >= 4.0) {
      grade = 'D - Trung bÃ¬nh';
      color = '#ffc107';
    } else {
      grade = 'F - KhÃ´ng Ä‘áº¡t';
      color = '#dc3545';
    }

    preview.textContent = grade;
    preview.style.color = color;
  }

  // Initialize preview on page load
  window.addEventListener('load', function () {
    updateGradePreview();
  });

  // Form validation
  document.getElementById('editFinalGradeForm').addEventListener('submit', function (e) {
    const diem_hp = document.querySelector('input[name="diem_hp"]').value;
    const ma_gv = document.querySelector('select[name="ma_gv"]').value;

    if (!diem_hp || !ma_gv) {
      e.preventDefault();
      alert('Vui lÃ²ng Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin!');
      return false;
    }

    if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n cáº­p nháº­t Ä‘iá»ƒm cuá»‘i ká»³ nÃ y?')) {
      return true;
    } else {
      e.preventDefault();
      return false;
    }
  });
</script>

{% endblock %}