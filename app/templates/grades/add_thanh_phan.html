{% extends "base.html" %}

{% block title %}Nh·∫≠p ƒêi·ªÉm Th√†nh ph·∫ßn{% endblock %}

{% block content %}
<div style="padding: 20px; max-width: 800px; margin: 0 auto;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>üìù Nh·∫≠p ƒêi·ªÉm Th√†nh ph·∫ßn</h2>
    <a href="{{ url_for('grades.list_thanh_phan') }}"
      style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
      ‚Üê Quay l·∫°i danh s√°ch
    </a>
  </div>

  <!-- Form -->
  <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <form method="POST" id="gradeForm">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- Th√¥ng tin sinh vi√™n -->
        <div>
          <label for="ma_sv" style="font-weight: bold; margin-bottom: 5px; display: block;">M√£ sinh vi√™n: <span
              style="color: red;">*</span></label>
          <select name="ma_sv" id="ma_sv" required
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- Ch·ªçn sinh vi√™n --</option>
            {% if data.students %}
            {% for student in data.students %}
            <option value="{{ student.ma_sv }}" data-name="{{ student.ho_ten }}"
              data-class="{{ student.lop.ten_lop if student.lop else '' }}">
              {{ student.ma_sv }} - {{ student.ho_ten }}
            </option>
            {% endfor %}
            {% endif %}
          </select>
        </div>

        <!-- M√¥n h·ªçc -->
        <div>
          <label for="ma_hp" style="font-weight: bold; margin-bottom: 5px; display: block;">M√¥n h·ªçc: <span
              style="color: red;">*</span></label>
          <select name="ma_hp" id="ma_hp" required
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
            {% if data.subjects %}
            {% for subject in data.subjects %}
            <option value="{{ subject.ma_hp }}">{{ subject.ma_hp }} - {{ subject.ten_hp }}</option>
            {% endfor %}
            {% endif %}
          </select>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- Gi√°o vi√™n -->
        <div>
          <label for="ma_gv" style="font-weight: bold; margin-bottom: 5px; display: block;">Gi√°o vi√™n: <span
              style="color: red;">*</span></label>
          <select name="ma_gv" id="ma_gv" required
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- Ch·ªçn gi√°o vi√™n --</option>
            {% if data.teachers %}
            {% for teacher in data.teachers %}
            <option value="{{ teacher.ma_gv }}">{{ teacher.ho_ten }}</option>
            {% endfor %}
            {% endif %}
          </select>
        </div>

        <!-- H·ªçc k·ª≥ -->
        <div>
          <label for="hoc_ky" style="font-weight: bold; margin-bottom: 5px; display: block;">H·ªçc k·ª≥: <span
              style="color: red;">*</span></label>
          <select name="hoc_ky" id="hoc_ky" required
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
            <option value="1">H·ªçc k·ª≥ 1</option>
            <option value="2">H·ªçc k·ª≥ 2</option>
            <option value="3">H·ªçc k·ª≥ 3</option>
          </select>
        </div>

        <!-- NƒÉm h·ªçc -->
        <div>
          <label for="hoc_ky" style="font-weight: bold; margin-bottom: 5px; display: block;">H·ªçc k·ª≥: <span
              style="color: red;">*</span></label>
          <select name="nam_hoc" id="nam_hoc" required
            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
            <option value="2023">2023-2024</option>
            <option value="2024">2024-2025</option>
            <option value="2025">2025-2026</option>
          </select>
        </div>
      </div>

      <!-- Th√¥ng tin hi·ªÉn th·ªã -->
      <div id="studentInfo"
        style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;">
        <h4>üë§ Th√¥ng tin sinh vi√™n ƒë√£ ch·ªçn:</h4>
        <p><strong>H·ªç t√™n:</strong> <span id="studentName">-</span></p>
        <p><strong>L·ªõp:</strong> <span id="studentClass">-</span></p>
      </div>

      <!-- ƒêi·ªÉm s·ªë -->
      <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0; color: #1976d2;">üìä Nh·∫≠p ƒëi·ªÉm th√†nh ph·∫ßn</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
          <!-- ƒêi·ªÉm chuy√™n c·∫ßn -->
          <div>
            <label for="diem_chuyen_can" style="font-weight: bold; margin-bottom: 5px; display: block;">
              ƒêi·ªÉm chuy√™n c·∫ßn (0-10): <span style="color: red;">*</span>
            </label>
            <input type="number" name="diem_chuyen_can" id="diem_chuyen_can" min="0" max="10" step="0.1" required
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
              oninput="calculateAverage()">
            <small style="color: #666;">ƒêi·ªÉm danh, tham gia l·ªõp</small>
          </div>

          <!-- ƒêi·ªÉm b√†i t·∫≠p -->
          <div>
            <label for="diem_bai_tap" style="font-weight: bold; margin-bottom: 5px; display: block;">
              ƒêi·ªÉm b√†i t·∫≠p (0-10): <span style="color: red;">*</span>
            </label>
            <input type="number" name="diem_bai_tap" id="diem_bai_tap" min="0" max="10" step="0.1" required
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
              oninput="calculateAverage()">
            <small style="color: #666;">B√†i t·∫≠p v·ªÅ nh√†, th·ª±c h√†nh</small>
          </div>

          <!-- ƒêi·ªÉm gi·ªØa k·ª≥ -->
          <div>
            <label for="diem_giua_ky" style="font-weight: bold; margin-bottom: 5px; display: block;">
              ƒêi·ªÉm gi·ªØa k·ª≥ (0-10): <span style="color: red;">*</span>
            </label>
            <input type="number" name="diem_giua_ky" id="diem_giua_ky" min="0" max="10" step="0.1" required
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
              oninput="calculateAverage()">
            <small style="color: #666;">Ki·ªÉm tra gi·ªØa k·ª≥</small>
          </div>
        </div>

        <!-- ƒêi·ªÉm trung b√¨nh t·ª± ƒë·ªông -->
        <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px; text-align: center;">
          <label style="font-weight: bold; color: #1976d2;">ƒêi·ªÉm trung b√¨nh th√†nh ph·∫ßn:</label>
          <div id="averageScore" style="font-size: 24px; font-weight: bold; color: #1976d2; margin-top: 5px;">-</div>
          <small style="color: #666;">T·ª± ƒë·ªông t√≠nh to√°n khi nh·∫≠p ƒë·ªß 3 ƒëi·ªÉm</small>
        </div>
      </div>

      <!-- ML Prediction Display -->
      <div id="mlPrediction"
        style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none;">
        <h3 style="margin-top: 0; color: #856404;">ü§ñ D·ª± ƒëo√°n AI v·ªÅ nguy c∆° tr∆∞·ª£t m√¥n</h3>
        <div id="predictionResult" style="font-size: 18px; font-weight: bold; margin: 10px 0;"></div>
        <div id="predictionDetails" style="font-size: 14px; color: #856404;"></div>
      </div>

      <!-- Ghi ch√∫ -->
      <div style="margin-bottom: 20px;">
        <label for="ghi_chu" style="font-weight: bold; margin-bottom: 5px; display: block;">Ghi ch√∫:</label>
        <textarea name="ghi_chu" id="ghi_chu" rows="3"
          style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
          placeholder="Ghi ch√∫ v·ªÅ ƒëi·ªÉm s·ªë (t√πy ch·ªçn)..."></textarea>
      </div>

      <!-- Buttons -->
      <div style="text-align: center; padding-top: 20px; border-top: 1px solid #eee;">
        <button type="submit"
          style="background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px;">
          ‚úÖ L∆∞u ƒëi·ªÉm
        </button>
        <button type="button" onclick="resetForm()"
          style="background: #6c757d; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-right: 10px;">
          üîÑ L√†m m·ªõi
        </button>
        <a href="{{ url_for('grades.list_thanh_phan') }}"
          style="background: #dc3545; color: white; padding: 12px 30px; border-radius: 5px; text-decoration: none; font-size: 16px;">
          ‚ùå H·ªßy b·ªè
        </a>
      </div>
    </form>
  </div>
</div>

<script>
  // Hi·ªÉn th·ªã th√¥ng tin sinh vi√™n khi ch·ªçn
  document.getElementById('ma_sv').addEventListener('change', function () {
    const selectedOption = this.options[this.selectedIndex];
    const studentInfo = document.getElementById('studentInfo');

    if (selectedOption.value) {
      document.getElementById('studentName').textContent = selectedOption.dataset.name || '-';
      document.getElementById('studentClass').textContent = selectedOption.dataset.class || '-';
      studentInfo.style.display = 'block';
    } else {
      studentInfo.style.display = 'none';
    }
  });

  // T√≠nh ƒëi·ªÉm trung b√¨nh v√† d·ª± ƒëo√°n ML
  function calculateAverage() {
    const cc = parseFloat(document.getElementById('diem_chuyen_can').value) || 0;
    const bt = parseFloat(document.getElementById('diem_bai_tap').value) || 0;
    const gk = parseFloat(document.getElementById('diem_giua_ky').value) || 0;

    if (cc > 0 && bt > 0 && gk > 0) {
      const average = (cc + bt + gk) / 3;
      const averageEl = document.getElementById('averageScore');
      averageEl.textContent = average.toFixed(1);

      // ƒê·ªïi m√†u theo ƒëi·ªÉm
      if (average >= 8) {
        averageEl.style.color = '#28a745';
      } else if (average >= 5) {
        averageEl.style.color = '#ffc107';
      } else {
        averageEl.style.color = '#dc3545';
      }

      // Hi·ªÉn th·ªã d·ª± ƒëo√°n ML (gi·∫£ l·∫≠p)
      showMLPrediction(average, cc, bt, gk);
    } else {
      document.getElementById('averageScore').textContent = '-';
      document.getElementById('averageScore').style.color = '#1976d2';
      document.getElementById('mlPrediction').style.display = 'none';
    }
  }

  // Hi·ªÉn th·ªã d·ª± ƒëo√°n ML
  function showMLPrediction(avg, cc, bt, gk) {
    const mlDiv = document.getElementById('mlPrediction');
    const resultDiv = document.getElementById('predictionResult');
    const detailDiv = document.getElementById('predictionDetails');

    // Logic d·ª± ƒëo√°n ƒë∆°n gi·∫£n (th·ª±c t·∫ø s·∫Ω g·ªçi API ML)
    let riskLevel = 'Th·∫•p';
    let riskColor = '#28a745';
    let advice = '';

    if (avg < 4) {
      riskLevel = 'R·∫•t cao';
      riskColor = '#dc3545';
      advice = 'C·∫ßn can thi·ªáp ngay l·∫≠p t·ª©c! Sinh vi√™n c√≥ nguy c∆° tr∆∞·ª£t m√¥n r·∫•t cao.';
    } else if (avg < 5) {
      riskLevel = 'Cao';
      riskColor = '#fd7e14';
      advice = 'C·∫ßn theo d√µi v√† h·ªó tr·ª£ th√™m. Nguy c∆° tr∆∞·ª£t m√¥n kh√° cao.';
    } else if (avg < 6.5) {
      riskLevel = 'Trung b√¨nh';
      riskColor = '#ffc107';
      advice = 'Sinh vi√™n c·∫ßn c·ªë g·∫Øng th√™m ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ t·ªët h∆°n.';
    } else {
      riskLevel = 'Th·∫•p';
      riskColor = '#28a745';
      advice = 'Sinh vi√™n ƒëang c√≥ k·∫øt qu·∫£ t·ªët, ti·∫øp t·ª•c duy tr√¨!';
    }

    resultDiv.innerHTML = `Nguy c∆° tr∆∞·ª£t m√¥n: <span style="color: ${riskColor};">${riskLevel}</span>`;
    detailDiv.textContent = advice;
    mlDiv.style.display = 'block';
  }

  // Reset form
  function resetForm() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ nh·∫≠p?')) {
      document.getElementById('gradeForm').reset();
      document.getElementById('studentInfo').style.display = 'none';
      document.getElementById('averageScore').textContent = '-';
      document.getElementById('averageScore').style.color = '#1976d2';
      document.getElementById('mlPrediction').style.display = 'none';
    }
  }

  // Validation tr∆∞·ªõc khi submit
  document.getElementById('gradeForm').addEventListener('submit', function (e) {
    const cc = parseFloat(document.getElementById('diem_chuyen_can').value) || 0;
    const bt = parseFloat(document.getElementById('diem_bai_tap').value) || 0;
    const gk = parseFloat(document.getElementById('diem_giua_ky').value) || 0;

    if (cc < 0 || cc > 10 || bt < 0 || bt > 10 || gk < 0 || gk > 10) {
      e.preventDefault();
      alert('ƒêi·ªÉm s·ªë ph·∫£i trong kho·∫£ng 0-10!');
      return false;
    }

    if (!confirm('X√°c nh·∫≠n l∆∞u ƒëi·ªÉm th√†nh ph·∫ßn cho sinh vi√™n n√†y?')) {
      e.preventDefault();
      return false;
    }
  });
</script>
{% endblock %}