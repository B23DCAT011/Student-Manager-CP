{% extends "base.html" %}

{% block title %}Sinh viên có nguy cơ trượt{% endblock %}

{% block content %}
<div style="padding: 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>⚠️ Sinh viên có nguy cơ trượt</h2>
    <a href="{{ url_for('grades.dashboard') }}"
      style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
      ← Quay lại Dashboard
    </a>
  </div>

  <!-- Alert Info -->
  <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h4 style="color: #856404; margin: 0 0 10px 0;">🎯 Tiêu chí đánh giá:</h4>
    <ul style="color: #856404; margin: 0;">
      <li>Sinh viên đã trượt ≥ 2 môn</li>
      <li>GPA hiện tại < 2.0</li>
      <li>Điểm thành phần thấp (< 5.0)</li>
      <li>Kết quả từ ML prediction model</li>
    </ul>
  </div>

  <!-- Filters -->
  <div
    style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <h3>🔍 Bộ lọc</h3>
    <form method="GET"
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
      <div>
        <label>Khoa:</label>
        <select name="khoa" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Tất cả --</option>
          <!-- Options sẽ được populate từ controller -->
        </select>
      </div>
      <div>
        <label>Ngành:</label>
        <select name="nganh" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Tất cả --</option>
          <!-- Options sẽ được populate từ controller -->
        </select>
      </div>
      <div>
        <label>Lớp:</label>
        <select name="lop" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Tất cả --</option>
          <!-- Options sẽ được populate từ controller -->
        </select>
      </div>
      <div style="display: flex; align-items: end;">
        <button type="submit"
          style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
          Lọc
        </button>
      </div>
    </form>
  </div>

  <!-- High-risk Students List -->
  <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3>📋 Danh sách sinh viên cần can thiệp</h3>
      <span style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 20px; font-size: 14px;">
        Tổng: <span id="total-count">{{ data.high_risk_count }}</span> sinh viên
      </span>
    </div>

    <!-- Table -->
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8f9fa;">
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Mã SV</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Họ tên</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Lớp</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">GPA</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Môn trượt</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Mức độ</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Hành động</th>
          </tr>
        </thead>
        <tbody>
          {% if data.high_risk_students %}
          {% for student in data.high_risk_students %}
          <tr>
            <td style="padding: 12px; border: 1px solid #dee2e6;">{{ student.ma_sv }}</td>
            <td style="padding: 12px; border: 1px solid #dee2e6;">
              <strong>{{ student.student.ho_ten if student.student else 'N/A' }}</strong>
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              {{ student.student.lop.ten_lop if student.student and student.student.lop else 'N/A' }}
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              <span>
                {{ "%.2f"|format(student.gpa_hien_tai or 0) }}
              </span>
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                {{ student.so_mon_da_truot or 0 }}
              </span>
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              {% if student.so_mon_da_truot >= 3 %}
              <span
                style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Cao</span>
              {% elif student.so_mon_da_truot >= 2 %}
              <span
                style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Trung
                bình</span>
              {% else %}
              <span
                style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Thấp</span>
              {% endif %}
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              <button onclick="contactStudent('{{ student.ma_sv }}')"
                style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">
                📧 Liên hệ
              </button>
              <button onclick="createSupportPlan('{{ student.ma_sv }}')"
                style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">
                📋 Kế hoạch
              </button>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="7" style="padding: 40px; text-align: center; color: #6c757d;">
              🎉 Không có sinh viên nào trong danh sách high-risk!
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Quick Actions -->
  <div
    style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px;">
    <h3>🚀 Hành động nhanh</h3>
    <div
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
      <button onclick="bulkEmailAlert()"
        style="background: #dc3545; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer;">
        📧 Gửi email cảnh báo hàng loạt
      </button>
      <button onclick="generateReport()"
        style="background: #007bff; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer;">
        📊 Xuất báo cáo PDF
      </button>
      <button onclick="scheduleIntervention()"
        style="background: #28a745; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer;">
        📅 Lên lịch can thiệp
      </button>
    </div>
  </div>
</div>

<script>
  function contactStudent(maSV) {
    // Lấy thông tin sinh viên từ bảng hiện tại
    const row = event.target.closest('tr');
    const studentName = row.querySelector('td:nth-child(2) strong').textContent.trim();

    // Tạo URL với parameters để pre-fill form (không có teacher_id - để user chọn)
    const url = `/email/contact?student_id=${encodeURIComponent(maSV)}&student_name=${encodeURIComponent(studentName)}`;

    window.location.href = url;
  }

  function createSupportPlan(maSV) {
    alert('Tạo kế hoạch hỗ trợ cho sinh viên ' + maSV);
    // TODO: Implement support plan creation
  }

  function bulkEmailAlert() {
    // Confirm trước khi gửi
    if (!confirm('Bạn có chắc chắn muốn gửi email cảnh báo cho tất cả sinh viên high-risk không?')) {
      return;
    }

    // Disable button và hiển thị loading
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '⏳ Đang gửi email...';

    // Thu thập dữ liệu từ bảng
    const studentData = [];
    const rows = document.querySelectorAll('tbody tr');

    rows.forEach(row => {
      // Kiểm tra nếu không phải row empty
      if (row.cells.length >= 7) {
        const maSV = row.cells[0].textContent.trim();
        const hoTen = row.cells[1].querySelector('strong').textContent.trim();
        const gpa = parseFloat(row.cells[3].textContent.trim());
        const soMonTruot = parseInt(row.cells[4].textContent.trim());

        // Xác định mức độ rủi ro
        let riskLevel = 'low';
        if (soMonTruot >= 3) {
          riskLevel = 'high';
        } else if (soMonTruot >= 2) {
          riskLevel = 'medium';
        }

        studentData.push({
          ma_sv: maSV,
          ho_ten: hoTen,
          gpa: gpa,
          so_mon_truot: soMonTruot,
          risk_level: riskLevel
        });
      }
    });

    // Gửi AJAX request
    fetch('http://127.0.0.1:5000/email/contact/bulk-warning', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        students: studentData,
        total_count: studentData.length
      })
    })
      .then(response => response.json())
      .then(data => {
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;

        if (data.success) {
          alert(`✅ Đã gửi email thành công!\n📧 Gửi thành công: ${data.sent_count}/${data.total_count} email`);
        } else {
          alert(`❌ Có lỗi xảy ra: ${data.message}\n📧 Gửi thành công: ${data.sent_count || 0}/${data.total_count || 0} email`);
        }
      })
      .catch(error => {
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;

        console.error('Error:', error);
        alert('❌ Lỗi kết nối mạng! Vui lòng thử lại.');
      });
  }

  function generateReport() {
    alert('Đang tạo báo cáo PDF...');
    // TODO: Implement PDF report generation
  }

  function scheduleIntervention() {
    alert('Lên lịch can thiệp cho sinh viên high-risk');
    // TODO: Implement intervention scheduling
  }
</script>
{% endblock %}