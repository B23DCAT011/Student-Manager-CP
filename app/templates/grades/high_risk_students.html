{% extends "base.html" %}

{% block title %}Sinh viÃªn cÃ³ nguy cÆ¡ trÆ°á»£t{% endblock %}

{% block content %}
<div style="padding: 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>âš ï¸ Sinh viÃªn cÃ³ nguy cÆ¡ trÆ°á»£t</h2>
    <a href="{{ url_for('grades.dashboard') }}"
      style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none;">
      â† Quay láº¡i Dashboard
    </a>
  </div>

  <!-- Alert Info -->
  <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
    <h4 style="color: #856404; margin: 0 0 10px 0;">ğŸ¯ TiÃªu chÃ­ Ä‘Ã¡nh giÃ¡:</h4>
    <ul style="color: #856404; margin: 0;">
      <li>Sinh viÃªn Ä‘Ã£ trÆ°á»£t â‰¥ 2 mÃ´n</li>
      <li>GPA hiá»‡n táº¡i < 2.0</li>
      <li>Äiá»ƒm thÃ nh pháº§n tháº¥p (< 5.0)</li>
      <li>Káº¿t quáº£ tá»« ML prediction model</li>
    </ul>
  </div>

  <!-- Filters -->
  <div
    style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <h3>ğŸ” Bá»™ lá»c</h3>
    <form method="GET"
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
      <div>
        <label>Khoa:</label>
        <select name="khoa" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Táº¥t cáº£ --</option>
          <!-- Options sáº½ Ä‘Æ°á»£c populate tá»« controller -->
        </select>
      </div>
      <div>
        <label>NgÃ nh:</label>
        <select name="nganh" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Táº¥t cáº£ --</option>
          <!-- Options sáº½ Ä‘Æ°á»£c populate tá»« controller -->
        </select>
      </div>
      <div>
        <label>Lá»›p:</label>
        <select name="lop" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">-- Táº¥t cáº£ --</option>
          <!-- Options sáº½ Ä‘Æ°á»£c populate tá»« controller -->
        </select>
      </div>
      <div style="display: flex; align-items: end;">
        <button type="submit"
          style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
          Lá»c
        </button>
      </div>
    </form>
  </div>

  <!-- High-risk Students List -->
  <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3>ğŸ“‹ Danh sÃ¡ch sinh viÃªn cáº§n can thiá»‡p</h3>
      <span style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 20px; font-size: 14px;">
        Tá»•ng: <span id="total-count">{{ data.high_risk_count }}</span> sinh viÃªn
      </span>
    </div>

    <!-- Table -->
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f8f9fa;">
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">MÃ£ SV</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">Há» tÃªn</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Lá»›p</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">GPA</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">MÃ´n trÆ°á»£t</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">Má»©c Ä‘á»™</th>
            <th style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody>
          {% if data.high_risk_students %}
          {% for student in data.high_risk_students %}
          <tr>
            <td style="padding: 12px; border: 1px solid #dee2e6;">{{ student.ma_sv }}</td>
            <td style="padding: 12px; border: 1px solid #dee2e6;">
              <strong>{{ student.student.ho_ten if student.student else 'N/A' }}</strong>
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              {{ student.student.lop.ten_lop if student.student and student.student.lop else 'N/A' }}
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              <span>
                {{ "%.2f"|format(student.gpa_hien_tai or 0) }}
              </span>
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                {{ student.so_mon_da_truot or 0 }}
              </span>
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              {% if student.so_mon_da_truot >= 3 %}
              <span
                style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Cao</span>
              {% elif student.so_mon_da_truot >= 2 %}
              <span
                style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Trung
                bÃ¬nh</span>
              {% else %}
              <span
                style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Tháº¥p</span>
              {% endif %}
            </td>
            <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
              <button onclick="contactStudent('{{ student.ma_sv }}')"
                style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">
                ğŸ“§ LiÃªn há»‡
              </button>
              <button onclick="createSupportPlan('{{ student.ma_sv }}')"
                style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">
                ğŸ“‹ Káº¿ hoáº¡ch
              </button>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="7" style="padding: 40px; text-align: center; color: #6c757d;">
              ğŸ‰ KhÃ´ng cÃ³ sinh viÃªn nÃ o trong danh sÃ¡ch high-risk!
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Quick Actions -->
  <div
    style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px;">
    <h3>ğŸš€ HÃ nh Ä‘á»™ng nhanh</h3>
    <div
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
      <button onclick="bulkEmailAlert()"
        style="background: #dc3545; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ“§ Gá»­i email cáº£nh bÃ¡o hÃ ng loáº¡t
      </button>
      <button onclick="generateReport()"
        style="background: #007bff; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ“Š Xuáº¥t bÃ¡o cÃ¡o PDF
      </button>
      <button onclick="scheduleIntervention()"
        style="background: #28a745; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer;">
        ğŸ“… LÃªn lá»‹ch can thiá»‡p
      </button>
    </div>
  </div>
</div>

<script>
  function contactStudent(maSV) {
    // Láº¥y thÃ´ng tin sinh viÃªn tá»« báº£ng hiá»‡n táº¡i
    const row = event.target.closest('tr');
    const studentName = row.querySelector('td:nth-child(2) strong').textContent.trim();

    // Táº¡o URL vá»›i parameters Ä‘á»ƒ pre-fill form (khÃ´ng cÃ³ teacher_id - Ä‘á»ƒ user chá»n)
    const url = `/email/contact?student_id=${encodeURIComponent(maSV)}&student_name=${encodeURIComponent(studentName)}`;

    window.location.href = url;
  }

  function createSupportPlan(maSV) {
    alert('Táº¡o káº¿ hoáº¡ch há»— trá»£ cho sinh viÃªn ' + maSV);
    // TODO: Implement support plan creation
  }

  function bulkEmailAlert() {
    // Confirm trÆ°á»›c khi gá»­i
    if (!confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n gá»­i email cáº£nh bÃ¡o cho táº¥t cáº£ sinh viÃªn high-risk khÃ´ng?')) {
      return;
    }

    // Disable button vÃ  hiá»ƒn thá»‹ loading
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = 'â³ Äang gá»­i email...';

    // Thu tháº­p dá»¯ liá»‡u tá»« báº£ng
    const studentData = [];
    const rows = document.querySelectorAll('tbody tr');

    rows.forEach(row => {
      // Kiá»ƒm tra náº¿u khÃ´ng pháº£i row empty
      if (row.cells.length >= 7) {
        const maSV = row.cells[0].textContent.trim();
        const hoTen = row.cells[1].querySelector('strong').textContent.trim();
        const gpa = parseFloat(row.cells[3].textContent.trim());
        const soMonTruot = parseInt(row.cells[4].textContent.trim());

        // XÃ¡c Ä‘á»‹nh má»©c Ä‘á»™ rá»§i ro
        let riskLevel = 'low';
        if (soMonTruot >= 3) {
          riskLevel = 'high';
        } else if (soMonTruot >= 2) {
          riskLevel = 'medium';
        }

        studentData.push({
          ma_sv: maSV,
          ho_ten: hoTen,
          gpa: gpa,
          so_mon_truot: soMonTruot,
          risk_level: riskLevel
        });
      }
    });

    // Gá»­i AJAX request
    fetch('http://127.0.0.1:5000/email/contact/bulk-warning', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        students: studentData,
        total_count: studentData.length
      })
    })
      .then(response => response.json())
      .then(data => {
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;

        if (data.success) {
          alert(`âœ… ÄÃ£ gá»­i email thÃ nh cÃ´ng!\nğŸ“§ Gá»­i thÃ nh cÃ´ng: ${data.sent_count}/${data.total_count} email`);
        } else {
          alert(`âŒ CÃ³ lá»—i xáº£y ra: ${data.message}\nğŸ“§ Gá»­i thÃ nh cÃ´ng: ${data.sent_count || 0}/${data.total_count || 0} email`);
        }
      })
      .catch(error => {
        // Restore button
        button.disabled = false;
        button.innerHTML = originalText;

        console.error('Error:', error);
        alert('âŒ Lá»—i káº¿t ná»‘i máº¡ng! Vui lÃ²ng thá»­ láº¡i.');
      });
  }

  function generateReport() {
    alert('Äang táº¡o bÃ¡o cÃ¡o PDF...');
    // TODO: Implement PDF report generation
  }

  function scheduleIntervention() {
    alert('LÃªn lá»‹ch can thiá»‡p cho sinh viÃªn high-risk');
    // TODO: Implement intervention scheduling
  }
</script>
{% endblock %}